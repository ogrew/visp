# リファクタリングタスク

## 高優先度

### ffmpeg実行エラーハンドリング強化
**対象**: `ffmpeg.lisp:3`の`run-cmd`関数

**現在の問題:**
- ffmpeg実行失敗時のエラー情報が不十分
- 出力ディレクトリの書き込み権限チェックなし
- 処理中断時の一時ファイル削除なし

**改善策:**
1. ffmpegの詳細エラーメッセージ取得
2. 事前の書き込み権限チェック
3. 処理中断時のクリーンアップ処理

## 中優先度

### コード品質改善

#### validate-merge-files関数の分割
**対象**: `validate.lisp:41`の`validate-merge-files`関数（約70行）

**問題**: 単一の関数が複数の責任を持ち、可読性が低下

**改善策**:
- ファイル存在チェック関数の分離
- MP4形式チェック関数の分離
- 重複ファイルチェック関数の分離

#### マジックナンバーの定数化
**対象**: `ffmpeg.lisp:20`のGIF fps計算など

**改善策**:
- `const.lisp`に定数を追加
- 意味のある定数名を付与

#### 命名の一貫性改善
**対象**: `options.lisp:11`

**問題**: `repeat`フィールドと`--loop`オプション名の不整合

**改善策**:
- フィールド名を`loop`に統一、または
- オプション名を`--repeat`に変更

### テスト改善

#### エラーケーステストの改善
**現在の問題:**
- validate系関数のエラーケースがテストされていない
- `(uiop:quit 1)`によるプロセス終了がテストフレームワークと非互換
- テストカバレッジが不十分で潜在的バグの発見が困難

**改善アプローチ（段階的実装推奨）:**
1. 1つの関数から例外ベースに段階的変更
2. 各段階でのバイナリビルド動作確認
3. エラーケーステストの段階的追加
4. リグレッション防止の強化

**注意**: 大規模な一括変更は避け、小さな改善を積み重ねる方式を採用する。

#### 統合テストの充実
**追加すべきテスト:**
- 実際のffmpeg実行を含むエンドツーエンドテスト
- エラーケースの異常系テスト
- バッチ処理でのファイル競合テスト

## 低優先度

### 新機能追加

#### 設定ファイル（プリセット）機能の追加
頻繁に使用するオプション組み合わせをプリセットとして保存：

```bash
visp --preset mobile-hd --input video.mp4  # プリセット使用
visp --save-preset mobile-hd --res hd --fps 30 --codec h264  # プリセット保存
```

#### 品質設定オプションの追加
ユーザビリティ向上のための品質プリセット：

```bash
visp --input video.mp4 --quality high    # 高品質（低圧縮）
visp --input video.mp4 --quality medium  # 標準品質
visp --input video.mp4 --quality low     # 高圧縮（ファイルサイズ優先）
```

#### プログレス表示機能
長時間処理での進捗表示：

```bash
visp --input large-video.mp4 --res 4k --progress
# [████████████████████████████████] 85% (02:45 remaining)
```

#### メタデータ保持オプション
元ファイルのメタデータ（タイトル、作成日時など）を保持：

```bash
visp --input video.mp4 --res fhd --keep-metadata
```

#### カスタムフィルタ機能
フィルタチェーンのカスタマイズ：

```bash
visp --input video.mp4 --filters "blur=3,sharpen=1,fade=in:0:30"
```

### パフォーマンス最適化
- バッチモードでの並列処理対応
- ffprobeの結果キャッシュ（同じファイルの重複解析回避）
- 大きなファイル処理時のメモリ最適化

## その他

### ドキュメント改善
- 内部関数のdocstring充実
- アーキテクチャ図の追加
- エラー解決ガイドの作成
- パフォーマンス指標の文書化

### 開発環境整備
- CI/CDパイプラインでの自動テスト
- コードカバレッジ測定
- リンター設定の強化
- 依存関係の自動更新

### 国際化対応
- 日本語コメントの英語化
- エラーメッセージの多言語対応
- ヘルプメッセージの国際化