# 開発ガイドライン

## ブランチ運用とワークフロー

### mainブランチ保護
- **mainブランチは保護されており、直接コミットできません**
- すべての作業は専用のfeatureブランチで行う必要があります
- 変更はPull Request経由でのみmainにマージ可能です

### ブランチ命名規則
```bash
feature/新機能名          # 新機能追加
fix/バグ修正名           # バグ修正
docs/ドキュメント更新名    # ドキュメント更新
refactor/リファクタリング内容 # リファクタリング
```

## 関数名の重複チェック

新しい関数を定義する際は、既存の関数名との重複を避けるため以下を確認してください：

### 1. 既存関数の検索
```bash
grep -r "defun 関数名" src/
```

### 2. パッケージエクスポートの確認
`src/package.lisp`で同名のシンボルがエクスポートされていないかチェック

### 3. テスト実行
関数定義後は必ず`make test`を実行して既存機能に影響がないことを確認

**重要**: Common Lispでは同じパッケージ内で同名関数を再定義すると警告なしに上書きされるため、特に注意が必要です。

## コード品質

### 命名規則
- 関数名: ケバブケース（`validate-merge-files`）
- 変数名: ケバブケース（`input-file`）
- 定数: アッパーケース（`*DEFAULT-CODEC*`）
- 述語関数: `-p`サフィックス（`file-exists-p`）

### docstring
- 全ての公開関数にdocstringを追加
- 引数と戻り値の説明を含める
- 使用例を可能な限り記載

### エラーハンドリング
- 段階的に`(uiop:quit 1)`から例外ベースへ移行
- ユーザーフレンドリーなエラーメッセージ
- 適切なクリーンアップ処理

## テストガイドライン

### テストファイル構成
```
t/
├── util-test.lisp          # ユーティリティ関数テスト
├── ffmpeg-test.lisp        # FFmpegコマンド構築テスト
├── validate-test.lisp      # 検証ロジックテスト
└── integration-test.lisp   # 統合テスト
```

### テスト実行
```bash
# 全テスト実行
make test

# 特定のテストファイル実行
ros run --eval "(ql:quickload :visp/test)" \
        --eval "(rove:run :visp/test/util)"
```

### テストカバレッジ
- 成功ケースと失敗ケースの両方をテスト
- エラーケースの段階的改善
- エンドツーエンドテストの充実

## Pull Request ガイドライン

### PR作成前チェックリスト
- [ ] `make test`が成功する
- [ ] `ros build visp.ros`でビルドが成功する
- [ ] 新機能に対応するテストが追加されている
- [ ] docstringが適切に記載されている
- [ ] 既存機能への影響がない

### PRタイトル・説明
- **タイトル**: 変更内容を簡潔に表現
- **説明**: 変更の背景、目的、影響範囲を記載
- **テスト計画**: 動作確認手順を明記

### レビュー観点
- コードの可読性・保守性
- テストの網羅性
- パフォーマンスへの影響
- セキュリティ観点での問題