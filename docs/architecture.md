# アーキテクチャ設計

## 核となるコンポーネント

- **main.lisp**: エントリーポイントと実行フローの制御
- **options.lisp**: CLI引数解析とvisp-options構造体
- **validate.lisp**: 入力検証とオプション互換性チェック
- **ffmpeg.lisp**: FFmpegコマンド構築と実行
- **video.lisp**: ffprobeを使用した動画メタデータ抽出
- **util.lisp**: ファイル名生成とパースユーティリティ
- **const.lisp**: 解像度マップ、コーデック設定、ファイル拡張子

## 実行フロー

1. **初期化**: ffmpeg可用性チェック、CLI引数をvisp-options構造体に解析
2. **検証**: モード（通常/マージ/GIF/バッチ）に基づく検証ディスパッチ
3. **モード選択**: 適切な処理モードへのルーティング
4. **コマンド構築**: 検証済みオプションに基づくffmpegコマンド生成
5. **実行**: ffmpeg実行またはドライラン出力表示

## 主要データ構造

### visp-options構造体
全解析済みオプションを含む中央設定オブジェクト。以下のフィールドを持つ：

- 入力ファイル/ディレクトリパス
- 出力設定（解像度、コーデック、フォーマット）
- 処理オプション（フレームレート、音声除去、ループ設定）
- モードフラグ（マージ、GIF、バッチ、ドライラン）

### 解像度定数
事前定義マッピング：
- hd = 1280x720
- fhd = 1920x1080
- 4k = 3840x2160
- その他の標準解像度

### コーデックマップ
拡張子とピクセルフォーマット付きエンコーダー設定：
- H.264 (libx264)
- H.265 (libx265) 
- VP9 (libvpx-vp9)
- AV1 (libaom-av1)

## 依存関係

### ランタイム
- **UIOP**: 唯一のCommon Lisp依存関係（SBCLに含まれる）
- **ffmpeg/ffprobe**: システムPATHで利用可能である必要がある

### 開発環境
- **SBCL + Roswell**: ビルドとREPL開発用
- **Rove**: テストフレームワーク（Quicklisp経由で読み込み）

## テストフレームワーク

`t/`ディレクトリのテストファイルでRoveテストライブラリを使用。以下をカバー：

- ユーティリティ関数のユニットテスト
- ffmpegコマンド構築ロジックのテスト
- オプション解析と検証のテスト
- 出力処理のテスト

### テスト実行環境
- Quicklisp経由でのRove読み込み
- プロジェクトローカルの`:visp/test`システム
- 段階的なテスト実行サポート